rules_version = '2';
service cloud.firestore {
  function isSignedIn(auth) {
    return auth != null && request.auth.token.email_verified;
  }
  match /databases/{database}/documents {
    function requestingUserIsMemberOfPartnerOwningResource(resource, request) {
      return resource.data.partnerID in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.partnerIds;
    }
    function requestingUserIsMemberOfPartner(resource, request) {
      return request.resource.data.partnerID in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.partnerIds;
    }
    function isAdmin(partnerId, request) {
      return get(/databases/$(database)/documents/partner/$(partnerId)/roles/$(request.auth.uid)).data.role == "admin"
    }
    match /plasma/{plasmaId} {
      allow read;
      allow delete, update: if isSignedIn(request.auth) && requestingUserIsMemberOfPartnerOwningResource(resource, request)
      allow create: if isSignedIn(request.auth) && requestingUserIsMemberOfPartner(resource, request)
    }
    match /partner/{partnerId} {
      allow read: if isSignedIn(request.auth) && exists(/databases/$(database)/documents/partner/$(partnerId)/roles/$(request.auth.uid))
      allow write: if false;
    }
    match /partner/{partnerId}/roles/{userId} {
      allow read,write: if false;
    }
    match /partner/{partnerId}/invites/{inviteId} {
      allow read,write: if isSignedIn(request.auth) && isAdmin(partnerId, request)
    }
    match /heros/{heroId} {
      allow read, write: if false;
    }
    match /mail/{mailId} {
      allow read, write: if false;
    }
    match /users/{userId} {
      allow read: if isSignedIn(request.auth) && request.auth.uid == userId;
      allow write: if false;
    }
  }
}
